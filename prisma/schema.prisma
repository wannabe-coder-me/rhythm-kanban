generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  emailVerified       DateTime?
  name                String?
  image               String?
  role                String               @default("member")
  createdAt           DateTime             @default(now())
  lastActiveAt        DateTime?
  accounts            Account[]
  activities          Activity[]
  attachments         Attachment[]
  ownedBoards         Board[]              @relation("BoardOwner")
  boardInvitesSent    BoardInvite[]        @relation("InviteSender")
  membersInvited      BoardMember[]        @relation("MemberInviter")
  boardMembers        BoardMember[]
  calendarConnections CalendarConnection[]
  comments            Comment[]
  notifications       Notification[]
  sessions            Session[]
  tasksAssigned       Task[]               @relation("TaskAssignee")
  tasksCreated        Task[]               @relation("TaskCreator")
  taskDependencies    TaskDependency[]
  taskTemplates       TaskTemplate[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Board {
  id            String             @id @default(uuid())
  name          String
  description   String?
  visibility    String             @default("private")
  ownerId       String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  owner         User               @relation("BoardOwner", fields: [ownerId], references: [id])
  emailAddress  BoardEmailAddress?
  invites       BoardInvite[]
  members       BoardMember[]
  columns       Column[]
  customFields  CustomField[]
  labels        Label[]
  taskTemplates TaskTemplate[]
}

model BoardEmailAddress {
  id            String   @id @default(uuid())
  boardId       String   @unique
  email         String   @unique
  columnId      String?
  isActive      Boolean  @default(true)
  autoAssign    Boolean  @default(false)
  requireMember Boolean  @default(false)
  createdAt     DateTime @default(now())
  board         Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([email])
}

model BoardMember {
  id          String    @id @default(uuid())
  boardId     String
  userId      String
  role        String    @default("member")
  invitedAt   DateTime  @default(now())
  invitedById String?
  joinedAt    DateTime?
  board       Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  invitedBy   User?     @relation("MemberInviter", fields: [invitedById], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
}

model BoardInvite {
  id          String    @id @default(uuid())
  boardId     String
  email       String
  role        String    @default("member")
  token       String    @unique @default(uuid())
  invitedById String
  status      String    @default("pending")
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  board       Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("InviteSender", fields: [invitedById], references: [id])

  @@unique([boardId, email])
  @@index([email, status])
  @@index([token])
}

model Column {
  id       String @id @default(uuid())
  boardId  String
  name     String
  position Int
  color    String @default("#6366f1")
  board    Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks    Task[]
}

model Task {
  id                 String             @id @default(uuid())
  columnId           String
  title              String
  description        String?
  position           Int
  priority           String             @default("medium")
  startDate          DateTime?
  dueDate            DateTime?
  completed          Boolean            @default(false)
  assigneeId         String?
  createdById        String
  parentId           String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  isRecurring        Boolean            @default(false)
  recurrenceRule     String?
  recurrenceEnd      DateTime?
  lastRecurrence     DateTime?
  parentRecurringId  String?
  activities         Activity[]
  attachments        Attachment[]
  calendarEvents     CalendarEvent[]
  comments           Comment[]
  customFieldValues  CustomFieldValue[]
  assignee           User?              @relation("TaskAssignee", fields: [assigneeId], references: [id])
  column             Column             @relation(fields: [columnId], references: [id], onDelete: Cascade)
  createdBy          User               @relation("TaskCreator", fields: [createdById], references: [id])
  parent             Task?              @relation("Subtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks           Task[]             @relation("Subtasks")
  parentRecurring    Task?              @relation("RecurringInstances", fields: [parentRecurringId], references: [id])
  recurringInstances Task[]             @relation("RecurringInstances")
  blocking           TaskDependency[]   @relation("BlockingTask")
  blockedBy          TaskDependency[]   @relation("BlockedTask")
  labels             Label[]            @relation("TaskLabels")
}

model TaskDependency {
  id          String   @id @default(uuid())
  taskId      String
  blockedById String
  createdAt   DateTime @default(now())
  createdById String
  blockedBy   Task     @relation("BlockingTask", fields: [blockedById], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id])
  task        Task     @relation("BlockedTask", fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, blockedById])
}

model Label {
  id        String   @id @default(uuid())
  boardId   String
  name      String
  color     String
  createdAt DateTime @default(now())
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]   @relation("TaskLabels")

  @@unique([boardId, name])
}

model Comment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

model Activity {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  action    String
  details   Json?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

model Attachment {
  id           String   @id @default(uuid())
  taskId       String
  filename     String
  url          String
  mimeType     String
  size         Int
  uploadedById String
  createdAt    DateTime @default(now())
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
}

model CustomField {
  id        String             @id @default(uuid())
  boardId   String
  name      String
  type      String
  options   String?
  required  Boolean            @default(false)
  position  Int                @default(0)
  createdAt DateTime           @default(now())
  board     Board              @relation(fields: [boardId], references: [id], onDelete: Cascade)
  values    CustomFieldValue[]

  @@unique([boardId, name])
}

model CustomFieldValue {
  id            String      @id @default(uuid())
  taskId        String
  customFieldId String
  value         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  task          Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, customFieldId])
}

model TaskTemplate {
  id          String   @id @default(uuid())
  boardId     String
  name        String
  title       String
  description String?
  priority    String   @default("medium")
  labels      String[]
  subtasks    String[]
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@unique([boardId, name])
}

model CalendarConnection {
  id             String          @id @default(uuid())
  userId         String
  provider       String          // "google" | "outlook"
  accessToken    String
  refreshToken   String?
  expiresAt      DateTime?
  calendarId     String?         // primary calendar ID
  email          String?         // calendar account email
  syncEnabled    Boolean         @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  events         CalendarEvent[]

  @@unique([userId, provider])
  @@index([userId])
}

model CalendarEvent {
  id                   String              @id @default(uuid())
  calendarConnectionId String
  externalEventId      String              // Google/Outlook event ID
  taskId               String?             // linked task (null if external event)
  title                String
  description          String?
  startTime            DateTime
  endTime              DateTime
  allDay               Boolean             @default(false)
  recurrence           String?             // RRULE string
  location             String?
  color                String?
  syncStatus           String              @default("synced") // synced, pending, error
  lastSyncAt           DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  calendarConnection   CalendarConnection  @relation(fields: [calendarConnectionId], references: [id], onDelete: Cascade)
  task                 Task?               @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@unique([calendarConnectionId, externalEventId])
  @@index([taskId])
  @@index([startTime, endTime])
}
